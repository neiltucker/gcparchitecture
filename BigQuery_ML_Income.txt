### Use BigQuery ML features
### Create a dataset names dataset1 before beginning

SELECT *
FROM `bigquery-public-data.ml_datasets.census_adult_income`
LIMIT 1000;

# Create a View
CREATE OR REPLACE VIEW `dataset1.census_income_view` AS
SELECT
  age,
  workclass,
  native_country,
  marital_status,
  education_num,
  occupation,
  race,
  hours_per_week,
  income_bracket,
  CASE
    WHEN MOD(functional_weight, 10) < 8 THEN 'training'
    WHEN MOD(functional_weight, 10) = 8 THEN 'evaluation'
    WHEN MOD(functional_weight, 10) = 9 THEN 'prediction'
  END AS dataframe
FROM `bigquery-public-data.ml_datasets.census_adult_income`

# Create / Train Model
CREATE OR REPLACE MODEL
  `dataset1.census_income_model`
OPTIONS
  ( model_type='LOGISTIC_REG',
    auto_class_weights=TRUE,
    data_split_method='NO_SPLIT',
    input_label_cols=['income_bracket'],
    max_iterations=15) AS
SELECT
  *
FROM
  `dataset1.census_income_view`
WHERE
  dataframe = 'training'

# Evaluate Model
SELECT
  *
FROM
  ML.EVALUATE (MODEL `dataset1.census_income_model`,
    (
    SELECT
      *
    FROM
      `dataset1.income_view`
    WHERE
      dataframe = 'evaluation'
    )
  )

# Predict using Model
SELECT
  *
FROM
  ML.PREDICT (MODEL `dataset1.census_income_model`,
    (
    SELECT
      *
    FROM
      `dataset1.census_income_view`
    WHERE
      dataframe = 'prediction'
     )
  )





